<div class="reservations-container">
    <div class="reservations-content">
        <!-- Toast message -->
        <div *ngIf="toastMessage" class="toast-message">
            {{ toastMessage }}
        </div>
        <div *ngIf="errorMessage" class="error-message">
            {{ errorMessage }}
        </div>

        <div class="reservations-list">
            <!-- ADMIN: Show both list and add form -->
            <ng-container *ngIf="isAdmin">
                <h2>Reservations</h2>
                <ul>
                    <li *ngFor="let reservation of reservations">
                        User: {{ reservation.appUserName }} ({{ reservation.appUserEmail }}) |
                        Room: {{ reservation.roomNumber }} ({{ reservation.roomType }}) |
                        Check-in: {{ reservation.checkIn }} |
                        Check-out: {{ reservation.checkOut }} |
                        Guests: {{ reservation.numGuests }} |
                        Status: {{ reservation.status }} |
                        Created: {{ reservation.createdAt }} |
                        Updated: {{ reservation.updatedAt }}
                        <div class="reservation-actions">
                            <button (click)="selectReservation(reservation)">Edit</button>
                            <button (click)="deleteReservation(reservation.id!)">Delete</button>
                        </div>
                    </li>
                </ul>
            </ng-container>

            <!-- USER: Only list if not roomIdFromQuery -->
            <ng-container *ngIf="!isAdmin && !roomIdFromQuery">
                <h2>Upcoming Reservations</h2>
                <ul *ngIf="upcomingReservations.length > 0; else noUpcoming">
                    <li *ngFor="let reservation of upcomingReservations">
                        Room: {{ reservation.roomNumber }} |
                        Check-in: {{ reservation.checkIn }} |
                        Check-out: {{ reservation.checkOut }} |
                        Guests: {{ reservation.numGuests }}
                        <button *ngIf="canCancel(reservation)"
                            (click)="cancelReservation(reservation.id)">Cancel</button>
                    </li>
                </ul>
                <ng-template #noUpcoming>
                    <div>No upcoming reservations.</div>
                </ng-template>
                <h2 style="margin-top:2rem;">Past Reservations</h2>
                <ul *ngIf="pastReservations.length > 0; else noPast">
                    <li *ngFor="let reservation of pastReservations">
                        Room: {{ reservation.roomNumber }} |
                        Check-in: {{ reservation.checkIn }} |
                        Check-out: {{ reservation.checkOut }} |
                        Guests: {{ reservation.numGuests }}
                    </li>
                </ul>
                <ng-template #noPast>
                    <div>No past reservations.</div>
                </ng-template>
            </ng-container>
        </div>

        <div class="reservation-form">
            <!-- ADMIN: Add form -->
            <ng-container *ngIf="isAdmin">
                <h3>Add Reservation</h3>
                <form (ngSubmit)="createReservation()">
                    <select [(ngModel)]="newReservation.appUserId" name="appUserId" required>
                        <option value="" disabled selected>Select User</option>
                        <option *ngFor="let user of users" [value]="user.id">
                            {{ user.name || user.email || ('User ' + user.id) }}
                        </option>
                    </select>
                    <select [(ngModel)]="newReservation.roomId" name="roomId" required
                        [disabled]="roomIdFromQuery !== null">
                        <option value="" disabled selected>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <input [(ngModel)]="newReservation.checkIn" name="checkIn" type="date" placeholder="Check-in"
                        required [min]="getMinDate()" [max]="getMaxDate()" [attr.disabledDates]="reservedDates">
                    <input [(ngModel)]="newReservation.checkOut" name="checkOut" type="date" placeholder="Check-out"
                        required [min]="getMinDate()" [max]="getMaxDate()" [attr.disabledDates]="reservedDates">
                    <label style="font-weight: 500; margin-bottom: 0.2rem; color: #333; display: block;">Number of
                        Guests</label>
                    <input [(ngModel)]="newReservation.numGuests" name="numGuests" type="number" min="1"
                        placeholder="Guests" required>
                    <input [(ngModel)]="newReservation.status" name="status" placeholder="Status" required>
                    <button type="submit">Add</button>
                </form>
            </ng-container>

            <!-- USER: Add form if roomIdFromQuery -->
            <ng-container *ngIf="!isAdmin && roomIdFromQuery">
                <h3>Add Reservation</h3>
                <form (ngSubmit)="startPaymentProcess()">
                    <input type="text" [value]="currentUserDisplayName" disabled>
                    <select [(ngModel)]="newReservation.roomId" name="roomId" required
                        [disabled]="roomIdFromQuery !== null">
                        <option value="" disabled selected>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <mat-form-field appearance="fill" style="width: 100%; margin-bottom: 1rem;">
                        <mat-label>Check-in</mat-label>
                        <input matInput [matDatepicker]="checkInPicker" [(ngModel)]="newReservation.checkIn"
                            name="checkIn" required [matDatepickerFilter]="dateFilter">
                        <mat-datepicker-toggle matSuffix [for]="checkInPicker"></mat-datepicker-toggle>
                        <mat-datepicker #checkInPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="fill" style="width: 100%; margin-bottom: 1rem;">
                        <mat-label>Check-out</mat-label>
                        <input matInput [matDatepicker]="checkOutPicker" [(ngModel)]="newReservation.checkOut"
                            name="checkOut" required [matDatepickerFilter]="dateFilter">
                        <mat-datepicker-toggle matSuffix [for]="checkOutPicker"></mat-datepicker-toggle>
                        <mat-datepicker #checkOutPicker></mat-datepicker>
                    </mat-form-field>
                    <h4>Number of Guests</h4>
                    <input [(ngModel)]="newReservation.numGuests" name="numGuests" type="number" min="1"
                        placeholder="Guests" required>
                    <button type="submit">Add</button>
                </form>
            </ng-container>

            <!-- Edit Reservation Form -->
            <div *ngIf="selectedReservation">
                <h3>Edit Reservation</h3>
                <form (ngSubmit)="updateReservation()">
                    <select [(ngModel)]="selectedReservation!.appUserId" name="editAppUserId" required>
                        <option value="" disabled>Select User</option>
                        <option *ngFor="let user of users" [value]="user.id">
                            {{ user.name || user.email || ('User ' + user.id) }}
                        </option>
                    </select>
                    <select [(ngModel)]="selectedReservation!.roomId" name="editRoomId" required>
                        <option value="" disabled>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <input [(ngModel)]="selectedReservation!.checkIn" name="editCheckIn" type="date" required>
                    <input [(ngModel)]="selectedReservation!.checkOut" name="editCheckOut" type="date" required>
                    <input [(ngModel)]="selectedReservation!.numGuests" name="editNumGuests" type="number" min="1"
                        required>
                    <input [(ngModel)]="selectedReservation!.status" name="editStatus" required>
                    <button type="submit">Update</button>
                    <button type="button" (click)="selectedReservation = null">Cancel</button>
                </form>
            </div>

            <div *ngIf="paymentInProgress">
                <h3>Payment Required</h3>
                <div id="card-element"></div>
                <button (click)="confirmPayment(clientSecret)">Pay</button>
            </div>
            <div *ngIf="paymentSuccess" class="success">
                Payment successful! Reservation confirmed.
            </div>
            <div *ngIf="paymentError" class="error-message" style="margin-top: 1em; color: #b00020; font-weight: bold;">
                {{ paymentError }}
            </div>
        </div>
    </div>
</div>