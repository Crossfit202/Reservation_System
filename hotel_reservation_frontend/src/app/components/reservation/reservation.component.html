<div class="reservations-container">
    <div class="reservations-content">
        <!-- Toast message -->
        <div *ngIf="toastMessage" class="toast-message">
            {{ toastMessage }}
        </div>
        <div *ngIf="errorMessage" class="error-message">
            {{ errorMessage }}
        </div>

        <div class="reservations-list">
            <!-- ADMIN: Show both list and add form -->
            <ng-container *ngIf="isAdmin">
                <h2
                    style="margin-top:0; position:sticky; top:0; background:rgba(255,255,255,0.95); z-index:2; padding-top:1rem;">
                    Reservations</h2>
                <div class="admin-reservation-list-scroll">
                    <div class="admin-reservation-list">
                        <div *ngFor="let reservation of reservations" class="admin-reservation-card">
                            <div class="admin-reservation-header">
                                <span class="admin-reservation-user"><strong>User:</strong> {{ reservation.appUserName
                                    }}
                                    <span class="admin-reservation-email">({{ reservation.appUserEmail }})</span></span>
                                <span class="admin-reservation-status"
                                    [ngClass]="{'status-canceled': reservation.status === 'CANCELED', 'status-confirmed': reservation.status === 'CONFIRMED'}">{{
                                    reservation.status }}</span>
                            </div>
                            <div class="admin-reservation-details">
                                <div><strong>Room:</strong> {{ reservation.roomNumber }} <span
                                        class="admin-reservation-roomtype">({{ reservation.roomType }})</span></div>
                                <div><strong>Check-in:</strong> {{ reservation.checkIn }}</div>
                                <div><strong>Check-out:</strong> {{ reservation.checkOut }}</div>
                                <div><strong>Guests:</strong> {{ reservation.numGuests }}</div>
                                <div><strong>Created:</strong> {{ reservation.createdAt }}</div>
                                <div><strong>Updated:</strong> {{ reservation.updatedAt }}</div>
                            </div>
                            <div class="reservation-actions">
                                <button (click)="selectReservation(reservation)">Edit</button>
                                <button (click)="deleteReservation(reservation.id!)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-container>

            <!-- USER: Only list if not roomIdFromQuery -->
            <ng-container *ngIf="!isAdmin && !roomIdFromQuery">
                <h2>Upcoming Reservations</h2>
                <div class="user-reservation-list">
                    <div *ngIf="upcomingReservations.length > 0; else noUpcoming">
                        <div *ngFor="let reservation of upcomingReservations" class="user-reservation-card">
                            <div class="user-reservation-details">
                                <div><strong>Room:</strong> {{ reservation.roomNumber }} <span
                                        class="user-reservation-roomtype">({{ reservation.roomType }})</span></div>
                                <div><strong>Check-in:</strong> {{ reservation.checkIn }}</div>
                                <div><strong>Check-out:</strong> {{ reservation.checkOut }}</div>
                                <div><strong>Guests:</strong> {{ reservation.numGuests }}</div>
                            </div>
                            <div class="user-reservation-header">
                                <span class="user-reservation-status"
                                    [ngClass]="{'status-canceled': reservation.status === 'CANCELED', 'status-confirmed': reservation.status === 'CONFIRMED'}">{{
                                    reservation.status }}</span>
                                <button *ngIf="canCancel(reservation) && reservation.status !== 'CANCELED'"
                                    (click)="openCancelModal(reservation.id)">Cancel</button>
                                <span *ngIf="reservation.status === 'CANCELED'"
                                    style="color:#b00020;font-weight:500;">Cancelled</span>
                            </div>
                            <!-- Cancel Confirmation Modal -->
                            <div class="modal-backdrop" *ngIf="showCancelModal">
                                <div class="modal">
                                    <p>Are you sure you want to cancel this reservation?</p>
                                    <button (click)="confirmCancelReservation()">Yes, Cancel</button>
                                    <button (click)="closeCancelModal()">No</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <ng-template #noUpcoming>
                    <div>No upcoming reservations.</div>
                </ng-template>
                <h2 style="margin-top:2rem;">Past Reservations</h2>
                <div class="user-reservation-list">
                    <div *ngIf="pastReservations.length > 0; else noPast">
                        <div *ngFor="let reservation of pastReservations" class="user-reservation-card">
                            <div class="user-reservation-header">
                                <span class="user-reservation-status"
                                    [ngClass]="{'status-canceled': reservation.status === 'CANCELED', 'status-confirmed': reservation.status === 'CONFIRMED'}">{{
                                    reservation.status }}</span>
                                <span *ngIf="reservation.status === 'CANCELED'"
                                    style="color:#b00020;font-weight:500;">Cancelled</span>
                            </div>
                            <div class="user-reservation-details">
                                <div><strong>Room:</strong> {{ reservation.roomNumber }} <span
                                        class="user-reservation-roomtype">({{ reservation.roomType }})</span></div>
                                <div><strong>Check-in:</strong> {{ reservation.checkIn }}</div>
                                <div><strong>Check-out:</strong> {{ reservation.checkOut }}</div>
                                <div><strong>Guests:</strong> {{ reservation.numGuests }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <ng-template #noPast>
                    <div>No past reservations.</div>
                </ng-template>
            </ng-container>
        </div>

        <div class="reservation-form">
            <!-- ADMIN: Add form -->
            <ng-container *ngIf="isAdmin">
                <h3>Add Reservation</h3>
                <form (ngSubmit)="createReservation()">
                    <select [(ngModel)]="newReservation.appUserId" name="appUserId" required>
                        <option value="" disabled selected>Select User</option>
                        <option *ngFor="let user of users" [value]="user.id">
                            {{ user.name || user.email || ('User ' + user.id) }}
                        </option>
                    </select>
                    <select [(ngModel)]="newReservation.roomId" name="roomId" required
                        [disabled]="roomIdFromQuery !== null">
                        <option value="" disabled selected>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <input [(ngModel)]="newReservation.checkIn" name="checkIn" type="date" placeholder="Check-in"
                        required [min]="getMinDate()" [max]="getMaxDate()" [attr.disabledDates]="reservedDates">
                    <input [(ngModel)]="newReservation.checkOut" name="checkOut" type="date" placeholder="Check-out"
                        required [min]="getMinDate()" [max]="getMaxDate()" [attr.disabledDates]="reservedDates">
                    <label style="font-weight: 500; margin-bottom: 0.2rem; color: #333; display: block;">Number of
                        Guests</label>
                    <input [(ngModel)]="newReservation.numGuests" name="numGuests" type="number" min="1"
                        placeholder="Guests" required>
                    <input [(ngModel)]="newReservation.status" name="status" placeholder="Status" required>
                    <button type="submit">Add</button>
                </form>
            </ng-container>

            <!-- USER: Add form if roomIdFromQuery -->
            <ng-container *ngIf="!isAdmin && roomIdFromQuery">
                <h3>Add Reservation</h3>
                <form (ngSubmit)="startPaymentProcess()">
                    <input type="text" [value]="currentUserDisplayName" disabled>
                    <select [(ngModel)]="newReservation.roomId" name="roomId" required
                        [disabled]="roomIdFromQuery !== null">
                        <option value="" disabled selected>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <mat-form-field appearance="fill" style="width: 100%; margin-bottom: 1rem;">
                        <mat-label>Check-in</mat-label>
                        <input matInput [matDatepicker]="checkInPicker" [(ngModel)]="newReservation.checkIn"
                            name="checkIn" required [matDatepickerFilter]="dateFilter">
                        <mat-datepicker-toggle matSuffix [for]="checkInPicker"></mat-datepicker-toggle>
                        <mat-datepicker #checkInPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="fill" style="width: 100%; margin-bottom: 1rem;">
                        <mat-label>Check-out</mat-label>
                        <input matInput [matDatepicker]="checkOutPicker" [(ngModel)]="newReservation.checkOut"
                            name="checkOut" required [matDatepickerFilter]="dateFilter">
                        <mat-datepicker-toggle matSuffix [for]="checkOutPicker"></mat-datepicker-toggle>
                        <mat-datepicker #checkOutPicker></mat-datepicker>
                    </mat-form-field>
                    <h4>Number of Guests</h4>
                    <input [(ngModel)]="newReservation.numGuests" name="numGuests" type="number" min="1"
                        placeholder="Guests" required>
                    <button type="submit">Add</button>
                </form>
            </ng-container>

            <!-- Edit Reservation Form -->
            <div *ngIf="selectedReservation">
                <h3>Edit Reservation</h3>
                <form (ngSubmit)="updateReservation()">
                    <select [(ngModel)]="selectedReservation!.appUserId" name="editAppUserId" required>
                        <option value="" disabled>Select User</option>
                        <option *ngFor="let user of users" [value]="user.id">
                            {{ user.name || user.email || ('User ' + user.id) }}
                        </option>
                    </select>
                    <select [(ngModel)]="selectedReservation!.roomId" name="editRoomId" required>
                        <option value="" disabled>Select Room</option>
                        <option *ngFor="let room of rooms" [value]="room.id">{{ room.roomNumber }}</option>
                    </select>
                    <input [(ngModel)]="selectedReservation!.checkIn" name="editCheckIn" type="date" required>
                    <input [(ngModel)]="selectedReservation!.checkOut" name="editCheckOut" type="date" required>
                    <input [(ngModel)]="selectedReservation!.numGuests" name="editNumGuests" type="number" min="1"
                        required>
                    <input [(ngModel)]="selectedReservation!.status" name="editStatus" required>
                    <button type="submit">Update</button>
                    <button type="button" (click)="selectedReservation = null">Cancel</button>
                </form>
            </div>

            <div *ngIf="paymentInProgress">
                <h3>Payment Required</h3>
                <div id="card-element"></div>
                <button (click)="confirmPayment(clientSecret)">Pay</button>
            </div>
            <div *ngIf="paymentSuccess" class="success">
                Payment successful! Reservation confirmed.
            </div>
            <div *ngIf="paymentError" class="error-message" style="margin-top: 1em; color: #b00020; font-weight: bold;">
                {{ paymentError }}
            </div>
        </div>
    </div>
</div>